---
// src/components/FavouriteCities.astro
const favouriteCities = [];
---

<div class="relative inline-block text-left">
	<!-- Always pill‑shaped, thick black border, consistent padding/font -->
	<button
		id="menu-button"
		type="button"
		class="inline-flex items-center justify-between rounded-full border-2 border-black bg-white px-6 py-2 text-lg font-medium whitespace-nowrap text-gray-900 focus:outline-none"
	>
		<span>Favorite Cities{favouriteCities}</span>
		<svg
			class="ml-2 h-4 w-4 text-gray-900"
			xmlns="http://www.w3.org/2000/svg"
			fill="currentColor"
			viewBox="0 0 20 20"
			aria-hidden="true"
		>
			<path
				fill-rule="evenodd"
				d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75
           .75 0 011.08 1.04l-4.25 4.5a.75.75 0 01-1.08
           0l-4.25-4.5a.75.75 0 01.02-1.06z"
				clip-rule="evenodd"></path>
		</svg>
	</button>

	<!-- Dropdown positioned under the button, full button‑width -->
	<div
		id="dropdown-menu"
		class="ring-opacity-5 absolute top-full left-0 mt-1 hidden min-w-full rounded-md bg-white shadow-lg ring-1 ring-black"
		role="menu"
		aria-orientation="vertical"
		aria-labelledby="menu-button"
	>
		<div id="dropdown-cities" class="py-1">
			{
				favouriteCities.map((city) => (
					<a
						href="#"
						class="city-link block px-4 py-2 text-lg whitespace-nowrap text-gray-900 hover:bg-gray-100"
						role="menuitem"
					>
						{city}
					</a>
				))
			}
		</div>
	</div>
</div>

<!-- Client-side script for toggling the dropdown, updating the label,
     and saving the selected city to local storage -->
<script client:load>
	// Grab DOM elements
	const dropdownCities = document.getElementById("dropdown-cities");
	const button = document.getElementById("dropdown-button");
	const menuButton = document.getElementById("menu-button");
	const dropdownMenu = document.getElementById("dropdown-menu");
	const buttonLabel = menuButton.querySelector("span");

	const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");

	if (favorites.length === 0) {
	dropdownCities.innerHTML = `<span class="block px-4 py-2 text-gray-500 text-sm">No favorites yet</span>`;
	} else {
		dropdownCities.innerHTML = favorites
			.map(({ city }) => `
				<a href="#" class="city-link block px-4 py-2 text-lg whitespace-nowrap text-gray-900 hover:bg-gray-100" role="menuitem">
					${city}
				</a>
			`)
			.join("");
	}

	dropdownCities.addEventListener("click", (e) => {
		if (!e.target.classList.contains("city-link")) return;
		e.preventDefault();

		const city = e.target.textContent.trim();
		const fav = favorites.find((f) => f.city === city);

		if (fav) {
			buttonLabel.textContent = city;
			localStorage.setItem("selectedCityData", JSON.stringify({ city, selectedAt: new Date().toISOString() }));

			const event = new CustomEvent("locationSelected", {
				detail: { location: fav.city, lat: fav.lat, lng: fav.lng },
				bubbles: true,
			});
			document.dispatchEvent(event);
		}

		dropdownMenu.classList.add("hidden");
	});

	const savedSelection = localStorage.getItem("selectedCityData");
	if (savedSelection) {
		try {
			const { city } = JSON.parse(savedSelection);
			if (city) buttonLabel.textContent = city;
		} catch {}
	}

	menuButton.addEventListener("click", (e) => {
		e.stopPropagation();
		dropdownMenu.classList.toggle("hidden");
	});

	document.addEventListener("click", () => {
		dropdownMenu.classList.add("hidden");
	});

</script>
