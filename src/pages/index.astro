---
import FavoriteCitySelect from "../components/FavoriteCitySelect.astro";
import Search from "../components/Search.astro";
import RootLayout from "../layout/RootLayout.astro";
---

<RootLayout title="Weather APP">
	<header class="mb-10 flex items-center justify-between">
		<h1 class="text-xl font-bold">Weather App</h1>
	</header>
	<main>
		<div class="flex justify-between">
			<FavoriteCitySelect />
			<Search />
		</div>
		<div class="relative w-[300px] mx-auto flex flex-col mb-12 text-center rounded-[15px] bg-gray-500/30 backdrop-blur-md border border-white/20 shadow-[0_5px_15px_rgba(0,0,0,0.35)] text-white">
			<h2 id="c-city" class="mt-3 text-4xl font-semibold text-white">City</h2>
			<div class="absolute right-3 top-1 text-3xl">★</div>
			<div class="flex flex-col justify-center">
				<div class="max-w-md mx-auto">
					<img class="w-30 h-30 object-cover" id="weather-icon" src="" alt="weather icon">
				</div>
				<span id="c-weather" class="text-2xl font-semibold text-white">---</span>
				<span id="c-temp" class="text-5xl font-semibold text-white">--°C</span>
			</div>
			<span id="c-date" class="mt-2 text-lg text-white mb-3">Weekday, Month DD, YYYY</span>
		</div>
		<div class="mb-8">
			Daily Forecast
			<div class="flex flex-wrap justify-around gap-4">
				<div class="w-28 rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<h3 class="font-semibold">Mon</h3>
					<span class="text-2xl">:sunny:</span>
					<p>20°C</p>
				</div>
				<div class="w-28 rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<h3 class="font-semibold">Tue</h3>
					<span class="text-2xl">:sunny:</span>
					<p>20°C</p>
				</div>
				<div class="w-28 rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<h3 class="font-semibold">Wed</h3>
					<span class="text-2xl">:sunny:</span>
					<p>20°C</p>
				</div>
				<div class="w-28 rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<h3 class="font-semibold">Thu</h3>
					<span class="text-2xl">:sunny:</span>
					<p>20°C</p>
				</div>
				<div class="w-28 rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<h3 class="font-semibold">Fri</h3>
					<span class="text-2xl">:sunny:</span>
					<p>20°C</p>
				</div>
			</div>
		</div>
		<section>
			Hourly Forecast
			<div class="flex flex-wrap justify-around gap-4">
				<div class="min-w-[100px] rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<p class="font-semibold">03:00</p>
					<span class="text-xl">:crescent_moon:</span>
					<p class="mt-1">15°C</p>
				</div>
				<div class="min-w-[100px] rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<p class="font-semibold">06:00</p>
					<span class="text-xl">:crescent_moon:</span>
					<p class="mt-1">15°C</p>
				</div>
				<div class="min-w-[100px] rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<p class="font-semibold">09:00</p>
					<span class="text-xl">:crescent_moon:</span>
					<p class="mt-1">15°C</p>
				</div>
				<div class="min-w-[100px] rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<p class="font-semibold">12:00</p>
					<span class="text-xl">:crescent_moon:</span>
					<p class="mt-1">15°C</p>
				</div>
				<div class="min-w-[100px] rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<p class="font-semibold">15:00</p>
					<span class="text-xl">:crescent_moon:</span>
					<p class="mt-1">15°C</p>
				</div>
				<div class="min-w-[100px] rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<p class="font-semibold">18:00</p>
					<span class="text-xl">:crescent_moon:</span>
					<p class="mt-1">15°C</p>
				</div>
				<div class="min-w-[100px] rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<p class="font-semibold">21:00</p>
					<span class="text-xl">:crescent_moon:</span>
					<p class="mt-1">15°C</p>
				</div>
				<div class="min-w-[100px] rounded-xl bg-white/50 p-4 text-center shadow backdrop-blur-md">
					<p class="font-semibold">00:00</p>
					<span class="text-xl">:crescent_moon:</span>
					<p class="mt-1">15°C</p>
				</div>
			</div>
		</section>
	</main>
	<script>
		import {getWeatherDescription} from '../utils/convertWeatherCode'
		let currentLocation = {
			latitude: "49.2827",
			longitude: "-123.1207",
		};
		navigator.geolocation.getCurrentPosition(
			(pos) => {
				currentLocation = {
					latitude: String(pos.coords.latitude),
					longitude: String(pos.coords.longitude),
				};
			},
			(_err) => {
				alert("failed to get the current position");
			},
		);

		const hourly = "temperature_2m,precipitation_probability,weather_code";
		const forecast_days = "5";
		const current = "temperature_2m,is_day,precipitation,weather_code,apparent_temperature";
		const daily = "weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset";
		const meteoUrl = "https://api.open-meteo.com/v1/forecast";
		const params = { ...currentLocation, current, daily, hourly, forecast_days };
		const urlSearchParams = new URLSearchParams(params);
		const url = `${meteoUrl}?${urlSearchParams}`;

		const fetchCurrentCity = async () => {
			const response = await fetch(`https://api.radar.io/v1/geocode/reverse?coordinates=${currentLocation.latitude},${currentLocation.longitude}`, {
  				headers: {
    				Authorization: "prj_live_pk_2fb2c81cb7c057cb30ce030dbd1f7a3b105179f9"
 			 }});
			const locationData = await response.json();
			const currentCity = locationData.addresses[0].city;

			return currentCity;
		}

		const fetchWeatherData = async () => {
			const response = await fetch(url);
			if (response.ok) {
				const fetchData = await response.json();
				/**
				 * Current Result Example
				 * interval: 900
				 * is_day: 1
				 * precipitation: 0
				 * temperature_2m: 13
				 * time: "2025-04-14T22:15"
				 * weather_code: 3
				 */
				const currentWeather = fetchData.current;
				console.log(currentWeather);

				document.body.style.backgroundImage = `url('${getWeatherDescription(currentWeather.weather_code).background}')`;
				document.body.style.backgroundRepeat = "no-repeat";
				document.body.style.backgroundSize = "cover";
				document.body.style.backgroundPosition = "center";

				const temp = currentWeather.temperature_2m;
				document.getElementById("c-temp").textContent = temp !== undefined? `${temp}℃` : "--℃";

				document.getElementById("c-city").textContent = await fetchCurrentCity();
				document.getElementById("weather-icon").src = getWeatherDescription(currentWeather.weather_code).image;
				document.getElementById("c-weather").textContent = getWeatherDescription(currentWeather.weather_code).name;

				const today = new Date();
				const formattedDate = today.toLocaleDateString("en-US", {
					weekday : "long",
					year : "numeric",
					month : "long",
					day : "numeric"
				})

				document.getElementById("c-date").textContent = formattedDate;

				const fiveDays = fetchData.daily.time;
				const fiveDaysTempMax = fetchData.daily.temperature_2m_max;
				const fiveDaysTempMin = fetchData.daily.temperature_2m_min;
				const fiveWeatherCode = fetchData.daily.weather_code;
				const fiveDaysWeather = fiveDays.map((f, index) => {
					return {
						day: f,
						tempMax: fiveDaysTempMax[index],
						tempMin: fiveDaysTempMin[index],
						weekCode: fiveWeatherCode[index],
					};
				});
				console.log(fiveDaysWeather);

				const selectedDate = "2025-04-15"; // ユーザー選択日
				const hourlyData = fetchData.hourly.time.map((time, index) => ({
					time,
					date: time.split("T")[0],
					hour: Number(time.split("T")[1].split(":")[0]),
					temperature: fetchData.hourly.temperature_2m[index],
					precipitationProbability: fetchData.hourly.precipitation_probability[index],
					weatherCode: fetchData.hourly.weather_code[index],
				}));

				const selectedDayHourly = hourlyData.filter((data) => data.date === selectedDate && data.hour % 3 === 0);
				console.log(selectedDayHourly);
			} else {
				alert("Failed to fetch weather data");
			}
		};

		document.addEventListener("DOMContentLoaded", async function () {
			await fetchWeatherData();
		});
	</script>
</RootLayout>
